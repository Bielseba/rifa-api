<% 
  const campaignsArr = Array.isArray(campaigns) ? campaigns : [];
  const totals = {
    campaigns: campaignsArr.length,
    expired: campaignsArr.filter(c=>c.status==='expired').length,
    active: campaignsArr.filter(c=>c.status==='active').length,
    winners: campaignsArr.filter(c=>c.winner).length
  };
%>

<div class="cards">
  <div class="card kpi"><div class="l">Campanhas</div><div class="v"><%= totals.campaigns %></div></div>
  <div class="card kpi"><div class="l">Ativas</div><div class="v"><%= totals.active %></div></div>
  <div class="card kpi"><div class="l">Expiradas</div><div class="v"><%= totals.expired %></div></div>
  <div class="card kpi"><div class="l">Com Ganhador</div><div class="v"><%= totals.winners %></div></div>
</div>

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Campanha</th>
      <th>Status</th>
      <th>Progresso</th>
      <th>Resultado</th>
      <th>Ganhador</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    <% if (!campaignsArr.length) { %>
      <tr><td colspan="7">Nenhuma campanha cadastrada.</td></tr>
    <% } %>
    <% campaignsArr.forEach(c => { %>
      <tr>
        <td>#<%= c.id %></td>
        <td style="max-width:280px">
          <div style="display:flex;align-items:center;gap:10px">
            <img src="<%= c.imageUrl || 'https://via.placeholder.com/56x40?text=%F0%9F%8E%9F' %>" alt="" style="width:56px;height:40px;object-fit:cover;border-radius:8px;border:1px solid #1f2740">
            <div>
              <div style="font-weight:600;line-height:1.1"><%= c.title %></div>
              <div class="muted" style="font-size:12px">ID <%= c.id %></div>
            </div>
          </div>
        </td>
        <td>
          <% if (c.status === 'active') { %><span class="badge b-active">active</span><% } %>
          <% if (c.status === 'upcoming') { %><span class="badge b-upcoming">upcoming</span><% } %>
          <% if (c.status === 'expired' || c.status === 'finished') { %><span class="badge b-expired"><%= c.status %></span><% } %>
        </td>
        <td><%= c.progress %>%</td>
        <td><%= c.resultDate ? new Date(c.resultDate).toLocaleString() : '-' %></td>
        <td>
          <% if (c.winner) { %>
            <div style="display:flex;flex-direction:column">
              <span><%= c.winner.name || ('Usuário #' + c.winner.userId) %></span>
              <span class="muted" style="font-size:12px">Nº <%= c.winner.ticketNumber || ('#' + c.winner.ticketId) %></span>
            </div>
          <% } else { %>
            <span class="muted">-</span>
          <% } %>
        </td>
        <td>
          <div class="actions">
            <a class="btn" href="/admin-ui/campaigns/<%= c.id %>/numbers">Gerenciar</a>
            <a class="btn ghost" href="/admin-ui/campaigns/new?duplicate=<%= encodeURIComponent(JSON.stringify({title:c.title,image_url:c.imageUrl,ticket_price:c.pricePerTicket,total_tickets:c.totalTickets,draw_date:c.resultDate})) %>">Duplicar</a>
          </div>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>
